<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Healthcare Training Registration Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg:      #f0f5ff;
    --surface: #ffffff;
    --card:    #ffffff;
    --border:  #d0e0f7;
    --accent:  #1a6fd4;
    --accent2: #0ea5e9;
    --accent3: #0369a1;
    --warn:    #f59e0b;
    --text:    #0f2a52;
    --muted:   #6b8cba;
    --success: #059669;
    --danger:  #dc2626;
    --glow:    0 0 30px rgba(26,111,212,0.15);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 15px; scroll-behavior: smooth; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; overflow-x: hidden;
    background-image:
      radial-gradient(ellipse 800px 500px at 0% 0%, rgba(26,111,212,0.06) 0%, transparent 70%),
      radial-gradient(ellipse 600px 600px at 100% 100%, rgba(14,165,233,0.05) 0%, transparent 70%);
  }

  /* HEADER */
  .header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(255,255,255,0.93); backdrop-filter: blur(24px);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 2px 16px rgba(26,111,212,0.08);
    padding: 0 2rem;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
  }
  .header-logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 18px; box-shadow: 0 0 20px rgba(26,111,212,0.3);
  }
  .logo-text {
    font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.1rem;
    letter-spacing: -0.02em;
    background: linear-gradient(90deg, var(--text), var(--accent));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .logo-sub { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }
  .header-right { display: flex; align-items: center; gap: 14px; }
  .conn-badge {
    display: flex; align-items: center; gap: 6px;
    border-radius: 20px; padding: 4px 12px;
    font-size: 0.72rem; font-weight: 500; letter-spacing: 0.05em;
    text-transform: uppercase; border: 1px solid; transition: all 0.3s;
  }
  .conn-badge.connecting { background:rgba(245,158,11,0.08); border-color:rgba(245,158,11,0.3); color:var(--warn); }
  .conn-badge.success    { background:rgba(5,150,105,0.08);  border-color:rgba(5,150,105,0.25); color:var(--success); }
  .conn-badge.error      { background:rgba(220,38,38,0.08);  border-color:rgba(220,38,38,0.25); color:var(--danger); }
  .conn-dot { width:7px; height:7px; border-radius:50%; background:currentColor; animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.7)} }
  .last-updated { font-size: 0.72rem; color: var(--muted); }
  .refresh-btn {
    display: flex; align-items: center; gap: 7px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 6px 14px; color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
  }
  .refresh-btn:hover { border-color: var(--accent); color: var(--accent); box-shadow: var(--glow); }
  .refresh-btn svg { transition: transform 0.5s; }
  .refresh-btn:hover svg { transform: rotate(180deg); }

  /* LOADING */
  .loading-screen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: calc(100vh - 64px); gap: 1rem;
  }
  .spinner {
    width: 44px; height: 44px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--muted); font-size: 0.9rem; }
  .loading-sub  { color: var(--muted); font-size: 0.78rem; }
  .error-card {
    background: var(--card); border: 1px solid #fca5a5; border-radius: 16px;
    padding: 2rem; max-width: 560px; margin: 2rem auto;
    box-shadow: 0 4px 20px rgba(220,38,38,0.08);
  }
  .error-title { font-family:'Syne',sans-serif; font-size:1rem; font-weight:700; color:var(--danger); margin-bottom:.5rem; }
  .error-body  { font-size:0.82rem; color:var(--muted); margin-bottom:1rem; line-height:1.6; }
  .debug-box {
    background:#f0f5ff; border:1px solid var(--border); border-radius:8px;
    padding:.75rem; font-family:monospace; font-size:0.72rem; color:var(--muted);
    margin-bottom:1rem; word-break:break-all;
  }
  .retry-btn {
    background:var(--accent); color:#fff; border:none; border-radius:8px;
    padding:8px 20px; font-family:'DM Sans',sans-serif; font-size:0.85rem;
    font-weight:500; cursor:pointer;
  }
  .retry-btn:hover { opacity:.85; }

  /* LAYOUT */
  .main { max-width: 1520px; margin: 0 auto; padding: 2rem; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
  @keyframes slideDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }

  /* FILTER BAR */
  .filter-section {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 1.5rem; margin-bottom: 1.75rem;
    box-shadow: 0 2px 12px rgba(26,111,212,0.06);
    animation: slideDown 0.45s ease;
  }
  .filter-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; }
  .filter-title {
    font-family:'Syne',sans-serif; font-size:0.8rem; font-weight:700;
    text-transform:uppercase; letter-spacing:0.1em; color:var(--muted);
  }
  .export-btn {
    display:flex; align-items:center; gap:7px;
    background:linear-gradient(135deg,#059669,#0ea5e9);
    border:none; border-radius:8px; padding:7px 16px;
    color:#fff; font-family:'DM Sans',sans-serif; font-size:0.8rem; font-weight:500;
    cursor:pointer; transition:opacity .2s, transform .15s;
  }
  .export-btn:hover { opacity:.88; transform:translateY(-1px); }
  .filter-row {
    display: flex; flex-wrap: wrap;
    gap: 12px; align-items: end;
  }
  .filter-group { display:flex; flex-direction:column; gap:6px; }
  .filter-label { font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; }
  .period-chips { display:flex; gap:6px; flex-wrap:wrap; }
  .chip {
    padding:5px 13px; border-radius:20px; border:1px solid var(--border);
    background:var(--bg); color:var(--muted); font-size:0.78rem;
    cursor:pointer; transition:all .18s; white-space:nowrap; font-family:'DM Sans',sans-serif;
  }
  .chip:hover { border-color:var(--accent); color:var(--accent); }
  .chip.active { background:rgba(26,111,212,0.12); border-color:var(--accent); color:var(--accent); font-weight:500; }
  .filter-input, .filter-select {
    background:var(--bg); border:1px solid var(--border); border-radius:8px;
    padding:7px 12px; color:var(--text); font-family:'DM Sans',sans-serif;
    font-size:0.85rem; outline:none; transition:border-color .2s; width:100%;
  }
  .filter-input:focus, .filter-select:focus { border-color:var(--accent); }
  .filter-input::placeholder { color:var(--muted); }
  .filter-input { min-width:140px; }
  .filter-select {
    min-width:170px; cursor:pointer; appearance:none; padding-right:28px;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236b8cba' stroke-width='2' stroke-linecap='round' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 10px center;
  }
  .filter-select option { background:var(--surface); }
  .apply-btn {
    display:flex; align-items:center; gap:7px;
    background:rgba(26,111,212,0.1); border:1px solid var(--accent);
    border-radius:8px; padding:7px 18px; color:var(--accent);
    font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:500;
    cursor:pointer; transition:all .2s; white-space:nowrap;
  }
  .apply-btn:hover { background:rgba(26,111,212,0.18); box-shadow:var(--glow); }
  .active-filters { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
  .filter-tag {
    display:flex; align-items:center; gap:7px;
    background:rgba(26,111,212,0.08); border:1px solid rgba(26,111,212,0.25);
    border-radius:20px; padding:4px 10px; font-size:0.75rem; color:var(--accent);
  }
  .filter-tag button {
    background:var(--danger); color:#fff; border:none; border-radius:10px;
    padding:1px 6px; font-size:0.68rem; cursor:pointer;
  }

  /* STATS */
  .stats-grid {
    display:grid; grid-template-columns:repeat(5,1fr);
    gap:16px; margin-bottom:1.75rem;
  }
  .stat-card {
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:1.4rem; position:relative; overflow:hidden;
    transition:transform .2s, box-shadow .2s;
    box-shadow:0 2px 12px rgba(26,111,212,0.06);
    animation:fadeUp 0.6s ease both;
  }
  .stat-card:nth-child(1){animation-delay:.05s}
  .stat-card:nth-child(2){animation-delay:.10s}
  .stat-card:nth-child(3){animation-delay:.15s}
  .stat-card:nth-child(4){animation-delay:.20s}
  .stat-card:nth-child(5){animation-delay:.25s}
  .stat-card:hover { transform:translateY(-3px); box-shadow:0 10px 32px rgba(26,111,212,0.12); }
  .stat-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    border-radius:16px 16px 0 0;
  }
  .stat-card.c1::before{background:linear-gradient(90deg,var(--accent),transparent)}
  .stat-card.c2::before{background:linear-gradient(90deg,var(--accent2),transparent)}
  .stat-card.c3::before{background:linear-gradient(90deg,var(--accent3),transparent)}
  .stat-card.c4::before{background:linear-gradient(90deg,var(--warn),transparent)}
  .stat-card.c5::before{background:linear-gradient(90deg,var(--success),transparent)}
  .stat-icon {
    width:38px; height:38px; border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    font-size:17px; margin-bottom:.9rem;
  }
  .c1 .stat-icon{background:rgba(26,111,212,0.1)}
  .c2 .stat-icon{background:rgba(14,165,233,0.1)}
  .c3 .stat-icon{background:rgba(3,105,161,0.1)}
  .c4 .stat-icon{background:rgba(245,158,11,0.1)}
  .c5 .stat-icon{background:rgba(5,150,105,0.1)}
  .stat-value {
    font-family:'Syne',sans-serif; font-size:2.2rem; font-weight:800;
    line-height:1; margin-bottom:4px;
  }
  .c1 .stat-value{color:var(--accent)}
  .c2 .stat-value{color:var(--accent2)}
  .c3 .stat-value{color:var(--accent3)}
  .c4 .stat-value{color:var(--warn)}
  .c5 .stat-value{color:var(--success)}
  .stat-label { font-size:0.82rem; color:var(--text); font-weight:500; margin-bottom:3px; }
  .stat-sub   { font-size:0.72rem; color:var(--muted); }

  /* CHARTS */
  .charts-row { display:grid; gap:16px; margin-bottom:1.75rem; }
  .charts-2col { grid-template-columns:1fr 1fr; }
  .charts-1col { grid-template-columns:1fr; }
  .chart-card {
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:1.5rem; box-shadow:0 2px 12px rgba(26,111,212,0.06);
    animation:fadeUp 0.6s ease 0.2s both;
  }
  .chart-header {
    display:flex; justify-content:space-between; align-items:flex-start;
    margin-bottom:1.25rem; padding-bottom:1rem; border-bottom:1px solid var(--border);
  }
  .chart-title { font-family:'Syne',sans-serif; font-size:0.95rem; font-weight:700; color:var(--text); }
  .chart-sub   { font-size:0.75rem; color:var(--muted); margin-top:2px; }
  .toggle-group {
    display:flex; background:var(--bg); border:1px solid var(--border);
    border-radius:8px; overflow:hidden;
  }
  .toggle-btn {
    padding:4px 11px; font-size:0.72rem; font-family:'DM Sans',sans-serif;
    background:none; border:none; color:var(--muted); cursor:pointer; transition:all .2s;
  }
  .toggle-btn.active { background:rgba(26,111,212,0.12); color:var(--accent); font-weight:600; }
  .toggle-btn:hover:not(.active) { color:var(--text); }
  .chart-canvas { position:relative; height:280px; }

  /* TABLE */
  .table-section {
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:1.5rem; box-shadow:0 2px 12px rgba(26,111,212,0.06);
    animation:fadeUp 0.6s ease 0.3s both;
  }
  .table-header {
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:1.25rem; flex-wrap:wrap; gap:12px;
  }
  .table-title { font-family:'Syne',sans-serif; font-size:0.95rem; font-weight:700; }
  .show-chips { display:flex; gap:5px; }
  .show-chip {
    padding:4px 12px; border-radius:6px; border:1px solid var(--border);
    background:var(--bg); color:var(--muted); font-size:0.75rem;
    cursor:pointer; transition:all .15s; font-family:'DM Sans',sans-serif;
  }
  .show-chip.active { background:rgba(14,165,233,0.12); border-color:var(--accent2); color:var(--accent2); font-weight:500; }
  .table-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; }
  thead { background:linear-gradient(90deg,var(--accent),var(--accent2)); }
  th {
    padding:11px 13px; text-align:left; font-family:'Syne',sans-serif;
    font-size:0.72rem; font-weight:700; color:#fff;
    text-transform:uppercase; letter-spacing:0.06em; white-space:nowrap;
  }
  td { padding:10px 13px; font-size:0.82rem; color:var(--text); border-bottom:1px solid rgba(208,224,247,0.5); }
  tbody tr:hover { background:rgba(26,111,212,0.03); }
  .td-muted { color:var(--muted); }
  .role-badge {
    display:inline-block; padding:2px 9px; border-radius:10px;
    font-size:0.7rem; font-weight:600; text-transform:uppercase;
    letter-spacing:0.04em; white-space:nowrap;
    background:rgba(26,111,212,0.1); color:var(--accent); border:1px solid rgba(26,111,212,0.2);
  }
  .own-gov     { background:rgba(5,150,105,0.08); color:var(--success); border:1px solid rgba(5,150,105,0.2); }
  .own-private { background:rgba(220,38,38,0.08); color:var(--danger);  border:1px solid rgba(220,38,38,0.2); }
  .own-faith   { background:rgba(245,158,11,0.08); color:var(--warn);   border:1px solid rgba(245,158,11,0.2); }
  .own-other   { background:rgba(14,165,233,0.08); color:var(--accent2); border:1px solid rgba(14,165,233,0.2); }
  .table-footer {
    display:flex; justify-content:space-between; align-items:center;
    margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border);
  }
  .row-count { font-size:0.78rem; color:var(--muted); }
  .empty-state { text-align:center; padding:3rem 1rem; color:var(--muted); }
  .empty-icon  { font-size:2.5rem; margin-bottom:.75rem; }

  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  @media (max-width:1200px) {
    .stats-grid { grid-template-columns:repeat(3,1fr); }
    .filter-row { flex-wrap:wrap; }
  }
  @media (max-width:900px) {
    .stats-grid { grid-template-columns:1fr 1fr; }
    .charts-2col { grid-template-columns:1fr; }
    .main { padding:1rem; }
  }
  @media (max-width:600px) {
    .stats-grid { grid-template-columns:1fr; }
    .header-right .last-updated { display:none; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-logo">
    <div class="logo-icon">üéì</div>
    <div>
      <div class="logo-text">Training Dashboard</div>
      <div class="logo-sub">Live Registration Analytics</div>
    </div>
  </div>
  <div class="header-right">
    <div class="conn-badge connecting" id="connBadge">
      <div class="conn-dot"></div>
      <span id="connText">Connecting...</span>
    </div>
    <span class="last-updated" id="lastUpdated"></span>
    <button class="refresh-btn" onclick="loadData()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      Refresh
    </button>
  </div>
</header>

<!-- LOADING SCREEN -->
<div id="loadingScreen" class="loading-screen">
  <div class="spinner"></div>
  <div class="loading-text">Loading data from Google Sheets...</div>
  <div class="loading-sub" id="loadingStatus">Connecting to data source...</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none">
  <main class="main">

    <!-- FILTERS -->
    <div class="filter-section">
      <div class="filter-header">
        <span class="filter-title">üîç Filters &amp; Controls</span>
        <button class="export-btn" onclick="exportToExcel()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export to Excel
        </button>
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">Quick Period</label>
          <div class="period-chips">
            <div class="chip" onclick="applyQuickPick(this,'today')">Today</div>
            <div class="chip" onclick="applyQuickPick(this,'yesterday')">Yesterday</div>
            <div class="chip" onclick="applyQuickPick(this,'7days')">7 Days</div>
            <div class="chip" onclick="applyQuickPick(this,'30days')">30 Days</div>
            <div class="chip active" onclick="applyQuickPick(this,'all')">All Time</div>
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">From Date</label>
          <input type="date" class="filter-input" id="fromDate">
        </div>
        <div class="filter-group">
          <label class="filter-label">To Date</label>
          <input type="date" class="filter-input" id="toDate">
        </div>
        <div class="filter-group">
          <label class="filter-label">Facility Ownership</label>
          <select class="filter-select" id="ownershipFilter" onchange="applyOwnershipFilter()">
            <option value="">All Facilities</option>
          </select>
        </div>
        <!-- NEW: Facility Level filter -->
        <div class="filter-group">
          <label class="filter-label">Facility Level</label>
          <select class="filter-select" id="levelFilter" onchange="applyLevelFilter()">
            <option value="">All Levels</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Facility Name</label>
          <input type="text" class="filter-input" id="facilitySearch" placeholder="Search facility..." oninput="applyFacilitySearch()">
        </div>
        <div class="filter-group">
          <label class="filter-label">&nbsp;</label>
          <button class="apply-btn" onclick="applyCustomRange()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Apply
          </button>
        </div>
      </div>
      <div class="active-filters" id="activeFilters"></div>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card c1"><div class="stat-icon">üìã</div><div class="stat-value" id="totalRegistrations">0</div><div class="stat-label">Total Registrations</div><div class="stat-sub">All time</div></div>
      <div class="stat-card c2"><div class="stat-icon">üåÖ</div><div class="stat-value" id="todayRegistrations">0</div><div class="stat-label">Today's Registrations</div><div class="stat-sub" id="todayDate"></div></div>
      <div class="stat-card c3"><div class="stat-icon">üìÖ</div><div class="stat-value" id="weekRegistrations">0</div><div class="stat-label">This Week</div><div class="stat-sub">Last 7 days</div></div>
      <div class="stat-card c4"><div class="stat-icon">üó∫Ô∏è</div><div class="stat-value" id="countiesCount">0</div><div class="stat-label">Counties Represented</div><div class="stat-sub">Out of 47</div></div>
      <div class="stat-card c5"><div class="stat-icon">üèõÔ∏è</div><div class="stat-value" id="facilityOwnership">0</div><div class="stat-label">Ownership Types</div><div class="stat-sub">Unique values</div></div>
    </div>

    <!-- Daily Chart -->
    <div class="charts-row charts-1col">
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">Daily Registrations</div><div class="chart-sub">Registration trend over time</div></div>
          <div class="toggle-group" id="dailyToggle">
            <button class="toggle-btn" onclick="setDailyPeriod(this,7)">7D</button>
            <button class="toggle-btn" onclick="setDailyPeriod(this,14)">14D</button>
            <button class="toggle-btn active" onclick="setDailyPeriod(this,30)">30D</button>
            <button class="toggle-btn" onclick="setDailyPeriod(this,60)">60D</button>
            <button class="toggle-btn" onclick="setDailyPeriod(this,'all')">All</button>
          </div>
        </div>
        <div class="chart-canvas"><canvas id="dailyChart"></canvas></div>
      </div>
    </div>

    <!-- Role + County -->
    <div class="charts-row charts-2col">
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">By Role</div><div class="chart-sub">Cadres represented</div></div>
          <div class="toggle-group" id="roleToggle">
            <button class="toggle-btn active" onclick="setRoleLimit(this,5)">Top 5</button>
            <button class="toggle-btn" onclick="setRoleLimit(this,8)">Top 8</button>
            <button class="toggle-btn" onclick="setRoleLimit(this,10)">Top 10</button>
            <button class="toggle-btn" onclick="setRoleLimit(this,'all')">All</button>
          </div>
        </div>
        <div class="chart-canvas"><canvas id="roleChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">By County</div><div class="chart-sub">Geographic distribution</div></div>
          <div class="toggle-group" id="countyToggle">
            <button class="toggle-btn active" onclick="setCountyLimit(this,5)">Top 5</button>
            <button class="toggle-btn" onclick="setCountyLimit(this,10)">Top 10</button>
            <button class="toggle-btn" onclick="setCountyLimit(this,15)">Top 15</button>
            <button class="toggle-btn" onclick="setCountyLimit(this,'all')">All</button>
          </div>
        </div>
        <div class="chart-canvas"><canvas id="countyChart"></canvas></div>
      </div>
    </div>

    <!-- Facility Level + Ownership -->
    <div class="charts-row charts-2col">
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">Facility Level</div><div class="chart-sub">Distribution by KEPH tier</div></div>
        </div>
        <div class="chart-canvas"><canvas id="facilityChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">Facility Ownership</div><div class="chart-sub">Ownership distribution</div></div>
        </div>
        <div class="chart-canvas"><canvas id="ownershipChart"></canvas></div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-section">
      <div class="table-header">
        <div>
          <div class="table-title">Recent Registrations</div>
          <div style="font-size:.78rem;color:var(--muted);margin-top:3px" id="tableSubtitle"></div>
        </div>
        <div class="show-chips" id="showChips">
          <div class="show-chip" onclick="setTableLimit(this,25)">25</div>
          <div class="show-chip" onclick="setTableLimit(this,50)">50</div>
          <div class="show-chip active" onclick="setTableLimit(this,100)">100</div>
          <div class="show-chip" onclick="setTableLimit(this,'all')">All</div>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date &amp; Time</th><th>Name</th><th>Email</th>
              <th>County</th><th>Facility</th><th>Role</th>
              <th>Ownership</th><th>Phone</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="table-footer">
        <div class="row-count" id="rowCount"></div>
      </div>
    </div>

  </main>
</div>

<script>
const PUBLISHED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTspwnQQtlpmk59QD_H50sMF7WKHsgdFxTI9K4QcBFYJ8K4-YB8WIZnZbEImE7dj7M2yPtcDCm2M9IJ/pub?output=csv';

const isLocalhost = ['localhost','127.0.0.1',''].includes(window.location.hostname);

const DATA_URLS = isLocalhost ? [
  `https://api.allorigins.win/get?url=${encodeURIComponent(PUBLISHED_CSV_URL)}`,
  `https://corsproxy.io/?${encodeURIComponent(PUBLISHED_CSV_URL)}`,
  PUBLISHED_CSV_URL
] : [
  PUBLISHED_CSV_URL,
  `https://api.allorigins.win/get?url=${encodeURIComponent(PUBLISHED_CSV_URL)}`,
  `https://corsproxy.io/?${encodeURIComponent(PUBLISHED_CSV_URL)}`
];

const OFFICIAL_COUNTIES = new Set([
  'baringo','bomet','bungoma','busia','elgeyo marakwet','embu','garissa','homa bay',
  'isiolo','kajiado','kakamega','kericho','kiambu','kilifi','kirinyaga','kisii','kisumu',
  'kitui','kwale','laikipia','lamu','machakos','makueni','mandera','marsabit','meru',
  'migori','mombasa','muranga',"murang'a",'nairobi','nakuru','nandi','narok','nyamira',
  'nyandarua','nyeri','samburu','siaya','taita taveta','tana river','tanariver',
  'tharaka nithi','tharaka-nithi','trans nzoia','turkana','uasin gishu','vihiga','wajir','west pokot'
]);

let allData=[], filteredData=[], columnMap={}, charts={};
let activeOwnershipFilter='', activeFacilitySearch='', activeLevelFilter='';
let tableLimit=100, dailyPeriod=30, roleLimit=5, countyLimit=5;

function normalizeOwnership(raw) {
  if (!raw) return 'Not Specified';
  const l = raw.toLowerCase().trim();
  if (l.includes('faith') || l==='fbo') return 'Faith Based';
  if (l.includes('gover') || l.includes('gok') || l.includes('county gov')) return 'Government (GOK/County)';
  if (l==='private' || l==='private facility') return 'Private';
  return 'Other';
}

function ownershipClass(o) {
  if (o.includes('Gov'))   return 'own-gov';
  if (o==='Private')       return 'own-private';
  if (o.includes('Faith')) return 'own-faith';
  return 'own-other';
}

const parseDate = d => {
  if (!d) return new Date();
  try {
    d = String(d).trim();
    if (d.includes('/')) {
      const [datePart, timePart='00:00:00'] = d.split(' ');
      const p = datePart.split('/');
      if (p.length===3) {
        let day,month,year;
        if (p[2].length===4)      { day=+p[0]; month=+p[1]; year=+p[2]; }
        else if (p[0].length===4) { year=+p[0]; month=+p[1]; day=+p[2]; }
        else                      { day=+p[0]; month=+p[1]; year=+p[2]; }
        const [h,m,s] = timePart.split(':').map(Number);
        return new Date(year, month-1, day, h||0, m||0, s||0);
      }
    }
    const parsed = new Date(d);
    return isNaN(parsed.getTime()) ? new Date() : parsed;
  } catch(e) { return new Date(); }
};

const dateToYMD = d =>
  `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

function getVal(row, field) {
  const col = columnMap[field];
  return col ? String(row[col]||'').trim() : '';
}

function detectColumns(headers) {
  columnMap = {};
  const hl = headers.map(h=>h.toLowerCase().trim());
  const map = {
    timestamp: ['timestamp','date','time','submitted at','submission date'],
    email:     ['email address','email','e-mail','emailaddress'],
    name:      ['your name','name','full name','respondent name'],
    facility:  ['facility name','facility','health facility','facility_name'],
    county:    ['county','county name'],
    ownership: ['facility ownership','ownership','facility_ownership','ownership type'],
    level:     ['facility level','level','facility_level','keph level'],
    phone:     ['phone number','phone','telephone','mobile','phone_number','contact'],
    role:      ['your role','role','designation','job title','position']
  };
  for (const [key,names] of Object.entries(map)) {
    for (const name of names) {
      const idx = hl.indexOf(name);
      if (idx!==-1) { columnMap[key]=headers[idx]; break; }
    }
    if (!columnMap[key]) {
      for (const name of names) {
        const idx = hl.findIndex(h=>h.includes(name)||name.includes(h));
        if (idx!==-1) { columnMap[key]=headers[idx]; break; }
      }
    }
  }
}

function setConnStatus(type, msg) {
  document.getElementById('connBadge').className=`conn-badge ${type}`;
  document.getElementById('connText').textContent=msg;
  const sub=document.getElementById('loadingStatus');
  if (sub) sub.textContent=msg;
}

function updateTimestamp() {
  document.getElementById('lastUpdated').textContent =
    'Updated '+new Date().toLocaleTimeString('en-KE',{hour:'2-digit',minute:'2-digit'});
}

async function loadData() {
  setConnStatus('connecting','Connecting...');
  const urls = DATA_URLS.map(url => {
    const ts = Date.now();
    return (url.includes('allorigins.win')||url.includes('corsproxy.io'))
      ? url+(url.includes('?')?'&':'?')+`_t=${ts}`
      : url+`&_t=${ts}`;
  });

  for (let i=0; i<urls.length; i++) {
    try {
      setConnStatus('connecting',`Trying method ${i+1}/${urls.length}...`);
      const rsp = await fetch(urls[i],{cache:'no-store',headers:{'Cache-Control':'no-cache'}});
      if (!rsp.ok) throw new Error(`HTTP ${rsp.status}`);

      let csv;
      if (urls[i].includes('allorigins.win')) {
        const data = await rsp.json();
        if (!data.contents) throw new Error('No contents in proxy response');
        csv = data.contents;
      } else {
        csv = await rsp.text();
      }

      if (csv.trim().startsWith('<!DOCTYPE')||csv.trim().startsWith('<html'))
        throw new Error('Got HTML ‚Äî sheet may not be published');

      Papa.parse(csv, {
        header:true, skipEmptyLines:true,
        complete: res => {
          const headers = Object.keys(res.data[0]||{});
          detectColumns(headers);
          const tsCol = columnMap.timestamp;
          if (!tsCol) throw new Error('Timestamp column not found. Columns: '+headers.join(', '));

          allData = res.data.filter(r => {
            const ts=r[tsCol];
            return ts && String(ts).trim() && ts!=='Timestamp';
          });

          if (allData.length===0) throw new Error('No valid data rows found');

          const isFirstLoad = document.getElementById('dashboard').style.display === 'none';

          if (isFirstLoad) {
            // First load: show all data, no filters
            filteredData=[...allData];
            populateOwnershipFilter();
            populateLevelFilter();
            processData();
            document.getElementById('loadingScreen').style.display='none';
            document.getElementById('dashboard').style.display='block';
          } else {
            // Auto-refresh: keep user's active filters ‚Äî do NOT reset
            applyFilter();
          }

          updateTimestamp();
          setConnStatus('success',`‚úì Live ‚Äî ${allData.length} records`);
        },
        error: err => { throw new Error('CSV parse: '+err.message); }
      });
      return;

    } catch(e) {
      console.warn(`Source ${i+1} failed:`,e.message);
      if (i===urls.length-1) {
        showError(e.message);
        setConnStatus('error','‚úï Connection failed');
      }
    }
  }
}

function showError(msg) {
  document.getElementById('loadingScreen').innerHTML=`
    <div class="error-card">
      <div class="error-title">‚ö†Ô∏è Could Not Load Data</div>
      <div class="error-body">${msg}<br><br>
        Make sure your Google Sheet is published to web as CSV (File ‚Üí Share ‚Üí Publish to web).</div>
      <div class="debug-box">Mode: ${isLocalhost?'Local':'Production'}<br>URL: ${PUBLISHED_CSV_URL}</div>
      <button class="retry-btn" onclick="location.reload()">üîÑ Retry</button>
    </div>`;
}

// ‚îÄ‚îÄ FILTER DROPDOWNS ‚îÄ‚îÄ (UPDATED TO USE FILTERED DATA)
function populateOwnershipFilter() {
  const counts={};
  // Changed from allData to filteredData
  filteredData.forEach(r=>{ 
    const o=normalizeOwnership(getVal(r,'ownership')); 
    counts[o]=(counts[o]||0)+1; 
  });
  const sel=document.getElementById('ownershipFilter');
  const cur=sel.value;
  sel.innerHTML='<option value="">All Facilities</option>';
  ['Government (GOK/County)','Private','Faith Based','Other'].forEach(o=>{
    if (counts[o]) sel.innerHTML+=`<option value="${o}">${o} (${counts[o]})</option>`;
  });
  
  // If the current selection no longer exists in filtered data, reset it
  if (cur && !counts[cur]) {
    sel.value = '';
    activeOwnershipFilter = '';
  } else if (cur) {
    sel.value = cur;
  }
}

// NEW: populate level filter from FILTERED data (not all data)
function populateLevelFilter() {
  const counts={};
  // Changed from allData to filteredData
  filteredData.forEach(r=>{ 
    const l=(getVal(r,'level')||'').trim().toUpperCase(); 
    if(l) counts[l]=(counts[l]||0)+1; 
  });
  const sel=document.getElementById('levelFilter');
  const cur=sel.value;
  sel.innerHTML='<option value="">All Levels</option>';
  Object.entries(counts).sort((a,b)=>a[0].localeCompare(b[0]))
    .forEach(([l,n])=>{ sel.innerHTML+=`<option value="${l}">${l} (${n})</option>`; });
  
  // If the current selection no longer exists in filtered data, reset it
  if (cur && !counts[cur]) {
    sel.value = '';
    activeLevelFilter = '';
  } else if (cur) {
    sel.value = cur;
  }
}

function applyQuickPick(el,v) {
  document.querySelectorAll('.period-chips .chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  const today=new Date(); let from,to;
  if (v==='today')          { from=to=today; }
  else if (v==='yesterday') { from=to=new Date(today); from.setDate(today.getDate()-1); }
  else if (v==='7days')     { from=new Date(today); from.setDate(today.getDate()-7); to=today; }
  else if (v==='30days')    { from=new Date(today); from.setDate(today.getDate()-30); to=today; }
  else                      { from=to=null; }
  document.getElementById('fromDate').value = from?dateToYMD(from):'';
  document.getElementById('toDate').value   = to?dateToYMD(to):'';
  applyFilter();
}

function applyCustomRange()     { applyFilter(); }
function applyOwnershipFilter() { activeOwnershipFilter=document.getElementById('ownershipFilter').value; applyFilter(); updateActiveTags(); }
function applyLevelFilter()     { activeLevelFilter=document.getElementById('levelFilter').value;         applyFilter(); updateActiveTags(); }
function applyFacilitySearch()  { activeFacilitySearch=document.getElementById('facilitySearch').value.trim().toLowerCase(); applyFilter(); updateActiveTags(); }
function clearOwnershipFilter() { activeOwnershipFilter=''; document.getElementById('ownershipFilter').value=''; applyFilter(); updateActiveTags(); }
function clearLevelFilter()     { activeLevelFilter='';     document.getElementById('levelFilter').value='';     applyFilter(); updateActiveTags(); }
function clearFacilitySearch()  { activeFacilitySearch='';  document.getElementById('facilitySearch').value='';  applyFilter(); updateActiveTags(); }

function updateActiveTags() {
  let h='';
  if (activeOwnershipFilter) h+=`<div class="filter-tag">Ownership: ${activeOwnershipFilter}<button onclick="clearOwnershipFilter()">‚úï</button></div>`;
  if (activeLevelFilter)     h+=`<div class="filter-tag">Level: ${activeLevelFilter}<button onclick="clearLevelFilter()">‚úï</button></div>`;
  if (activeFacilitySearch)  h+=`<div class="filter-tag">Facility: "${activeFacilitySearch}"<button onclick="clearFacilitySearch()">‚úï</button></div>`;
  document.getElementById('activeFilters').innerHTML=h;
}

function applyFilter() {
  const from=document.getElementById('fromDate').value;
  const to=document.getElementById('toDate').value;
  const tsCol=columnMap.timestamp;
  
  // First apply date filters only (without ownership/level/facility filters)
  filteredData=allData.filter(r=>{
    const d=parseDate(r[tsCol]);
    if (from && d<new Date(from)) return false;
    if (to   && d>new Date(to+'T23:59:59')) return false;
    return true;
  });
  
  // Refresh both dropdowns based on date-filtered data
  populateOwnershipFilter();
  populateLevelFilter();
  
  // Now apply all filters including ownership, level, and facility search
  filteredData=allData.filter(r=>{
    const d=parseDate(r[tsCol]);
    if (from && d<new Date(from)) return false;
    if (to   && d>new Date(to+'T23:59:59')) return false;
    if (activeOwnershipFilter && normalizeOwnership(getVal(r,'ownership'))!==activeOwnershipFilter) return false;
    if (activeLevelFilter     && (getVal(r,'level')||'').trim().toUpperCase()!==activeLevelFilter) return false;
    if (activeFacilitySearch  && !getVal(r,'facility').toLowerCase().includes(activeFacilitySearch)) return false;
    return true;
  });
  
  processData();
}

function processData() {
  const today=new Date(), tsCol=columnMap.timestamp;
  const weekAgo=new Date(today); weekAgo.setDate(today.getDate()-7);

  document.getElementById('totalRegistrations').textContent=filteredData.length.toLocaleString();
  document.getElementById('todayRegistrations').textContent=filteredData.filter(r=>parseDate(r[tsCol]).toDateString()===today.toDateString()).length;
  document.getElementById('weekRegistrations').textContent=filteredData.filter(r=>parseDate(r[tsCol])>=weekAgo).length;
  document.getElementById('todayDate').textContent=today.toLocaleDateString('en-GB');

  const seen=new Set();
  filteredData.forEach(r=>{
    const raw=getVal(r,'county').replace(/\s+/g,' ').toLowerCase().replace(/-/g,' ').replace(/'/g,"'");
    if (OFFICIAL_COUNTIES.has(raw)) seen.add(raw);
  });
  document.getElementById('countiesCount').textContent=seen.size;

  const ownSet=new Set();
  filteredData.forEach(r=>{ const o=normalizeOwnership(getVal(r,'ownership')); if(o&&o!=='Not Specified') ownSet.add(o); });
  document.getElementById('facilityOwnership').textContent=ownSet.size;

  updateDailyChart();
  updateRoleChart();
  updateCountyChart();
  updateFacilityChart();
  updateOwnershipChart();
  updateTable();
}

const COLORS=['#1a6fd4','#0ea5e9','#0369a1','#38bdf8','#7dd3fc','#bae6fd','#f59e0b','#059669','#dc2626','#6366f1'];
function destroyChart(id){ if(charts[id]){charts[id].destroy();delete charts[id];} }

function setDailyPeriod(el,v){ document.querySelectorAll('#dailyToggle .toggle-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); dailyPeriod=v; updateDailyChart(); }
function setRoleLimit(el,v)  { document.querySelectorAll('#roleToggle .toggle-btn').forEach(b=>b.classList.remove('active'));  el.classList.add('active'); roleLimit=v;   updateRoleChart(); }
function setCountyLimit(el,v){ document.querySelectorAll('#countyToggle .toggle-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); countyLimit=v; updateCountyChart(); }

function updateDailyChart(){
  const tsCol=columnMap.timestamp, daily={};
  filteredData.forEach(r=>{ const d=parseDate(r[tsCol]).toLocaleDateString('en-GB'); daily[d]=(daily[d]||0)+1; });
  let sorted=Object.entries(daily).sort((a,b)=>{
    const [da,ma,ya]=a[0].split('/'), [db,mb,yb]=b[0].split('/');
    return (ya+ma+da).localeCompare(yb+mb+db);
  });
  if (dailyPeriod!=='all') sorted=sorted.slice(-dailyPeriod);
  destroyChart('daily');
  charts.daily=new Chart(document.getElementById('dailyChart'),{
    type:'line',
    data:{labels:sorted.map(([d])=>d),datasets:[{label:'Registrations',data:sorted.map(([,v])=>v),borderColor:'#1a6fd4',backgroundColor:'rgba(26,111,212,0.08)',tension:0.35,fill:true,pointRadius:3,pointBackgroundColor:'#1a6fd4',borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1,color:'#6b8cba'},grid:{color:'rgba(208,224,247,0.6)'}},x:{ticks:{color:'#6b8cba',maxRotation:45},grid:{display:false}}}}
  });
}

function updateRoleChart(){
  const role={};
  filteredData.forEach(r=>{const k=getVal(r,'role')||'Not Specified'; role[k]=(role[k]||0)+1;});
  let sorted=Object.entries(role).sort((a,b)=>b[1]-a[1]);
  if (roleLimit!=='all') sorted=sorted.slice(0,roleLimit);
  destroyChart('role');
  charts.role=new Chart(document.getElementById('roleChart'),{
    type:'doughnut',
    data:{labels:sorted.map(([k])=>k),datasets:[{data:sorted.map(([,v])=>v),backgroundColor:COLORS,borderWidth:2,borderColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12,padding:10,font:{size:11},color:'#0f2a52'}}}}
  });
}

function updateCountyChart(){
  const county={};
  filteredData.forEach(r=>{const c=getVal(r,'county')||'Not Specified'; county[c]=(county[c]||0)+1;});
  let sorted=Object.entries(county).sort((a,b)=>b[1]-a[1]);
  if (countyLimit!=='all') sorted=sorted.slice(0,countyLimit);
  destroyChart('county');
  charts.county=new Chart(document.getElementById('countyChart'),{
    type:'bar',
    data:{labels:sorted.map(([k])=>k),datasets:[{label:'Registrations',data:sorted.map(([,v])=>v),backgroundColor:'#1a6fd4',borderRadius:4}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{color:'#6b8cba'},grid:{color:'rgba(208,224,247,0.6)'}},y:{ticks:{color:'#0f2a52',font:{size:11}},grid:{display:false}}}}
  });
}

function updateFacilityChart(){
  const lvl={};
  filteredData.forEach(r=>{const k=(getVal(r,'level')||'Not Specified').toUpperCase(); lvl[k]=(lvl[k]||0)+1;});
  const sorted=Object.entries(lvl).sort((a,b)=>a[0].localeCompare(b[0]));
  destroyChart('facility');
  charts.facility=new Chart(document.getElementById('facilityChart'),{
    type:'bar',
    data:{labels:sorted.map(([k])=>k),datasets:[{label:'Registrations',data:sorted.map(([,v])=>v),backgroundColor:COLORS,borderRadius:6}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1,color:'#6b8cba'},grid:{color:'rgba(208,224,247,0.6)'}},x:{ticks:{color:'#0f2a52'},grid:{display:false}}}}
  });
}

function updateOwnershipChart(){
  const own={};
  filteredData.forEach(r=>{const k=normalizeOwnership(getVal(r,'ownership')); own[k]=(own[k]||0)+1;});
  const sorted=Object.entries(own).sort((a,b)=>b[1]-a[1]);
  destroyChart('ownership');
  charts.ownership=new Chart(document.getElementById('ownershipChart'),{
    type:'bar',
    data:{labels:sorted.map(([k])=>k),datasets:[{label:'Facilities',data:sorted.map(([,v])=>v),backgroundColor:['#1a6fd4','#059669','#f59e0b','#0ea5e9'],borderRadius:6}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1,color:'#6b8cba'},grid:{color:'rgba(208,224,247,0.6)'}},x:{ticks:{color:'#0f2a52'},grid:{display:false}}}}
  });
}

function setTableLimit(el,v){
  document.querySelectorAll('.show-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); tableLimit=v; updateTable();
}

function updateTable(){
  const tsCol=columnMap.timestamp;
  let data=[...filteredData].sort((a,b)=>parseDate(b[tsCol])-parseDate(a[tsCol]));
  const total=data.length;
  if (tableLimit!=='all') data=data.slice(0,tableLimit);
  const tbody=document.getElementById('tableBody');
  if (!data.length) {
    tbody.innerHTML=`<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üì≠</div><p>No registrations match the current filters</p></div></td></tr>`;
  } else {
    tbody.innerHTML=data.map(r=>{
      const own=normalizeOwnership(getVal(r,'ownership'));
      return `<tr>
        <td class="td-muted">${getVal(r,'timestamp')||'-'}</td>
        <td style="font-weight:500">${getVal(r,'name')||'-'}</td>
        <td class="td-muted">${getVal(r,'email')||'-'}</td>
        <td>${getVal(r,'county')||'-'}</td>
        <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${getVal(r,'facility')}">${getVal(r,'facility')||'-'}</td>
        <td><span class="role-badge">${getVal(r,'role')||'-'}</span></td>
        <td><span class="role-badge ${ownershipClass(own)}">${own}</span></td>
        <td class="td-muted">${getVal(r,'phone')||'-'}</td>
      </tr>`;
    }).join('');
  }
  document.getElementById('rowCount').textContent=`Showing ${Math.min(data.length,total)} of ${total} entries`;
  document.getElementById('tableSubtitle').textContent=`${tableLimit==='all'?'All':tableLimit} most recent entries`;
}

function exportToExcel(){
  const wb=XLSX.utils.book_new();
  const rows=filteredData.map(r=>({
    'Timestamp':          getVal(r,'timestamp'),
    'Name':               getVal(r,'name'),
    'Email':              getVal(r,'email'),
    'County':             getVal(r,'county'),
    'Facility Name':      getVal(r,'facility'),
    'Facility Level':     getVal(r,'level'),
    'Facility Ownership': normalizeOwnership(getVal(r,'ownership')),
    'Role':               getVal(r,'role'),
    'Phone Number':       getVal(r,'phone')
  }));
  const ws=XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,'Registrations');
  XLSX.writeFile(wb,`Training_Registrations_${new Date().toISOString().slice(0,10)}.xlsx`);
}

loadData();
setInterval(()=>{ loadData(); }, 30000);
</script>
</body>
</html>
